<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Reports - Admin Portal</title>
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-brand">
                    <div class="logo">P</div>
                    <span>Student Portal</span>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main Menu</div>
                    <a href="dashboard.html" class="nav-link" data-page="dashboard">
                        <span class="icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                    <a href="students.html" class="nav-link" data-page="students">
                        <span class="icon">üë®‚Äçüéì</span>
                        <span>Students</span>
                    </a>
                    <a href="teachers.html" class="nav-link" data-page="teachers">
                        <span class="icon">üë®‚Äçüè´</span>
                        <span>Teachers</span>
                    </a>
                    <a href="courses.html" class="nav-link" data-page="courses">
                        <span class="icon">üìö</span>
                        <span>Courses</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Reports</div>
                    <a href="attendance-report.html" class="nav-link active" data-page="attendance-report">
                        <span class="icon">üìã</span>
                        <span>Attendance Reports</span>
                    </a>
                    <a href="results-report.html" class="nav-link" data-page="results-report">
                        <span class="icon">üìà</span>
                        <span>Result Reports</span>
                    </a>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">AD</div>
                    <div class="user-details">
                        <div class="user-name">Administrator</div>
                        <div class="user-role">admin</div>
                    </div>
                    <button class="logout-btn" title="Logout">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-header">
                <div class="header-left">
                    <button class="menu-toggle">‚ò∞</button>
                    <div>
                        <h1 class="page-title">Attendance Reports</h1>
                        <nav class="breadcrumb">
                            <a href="dashboard.html">Home</a>
                            <span class="breadcrumb-separator">/</span>
                            <span>Reports</span>
                            <span class="breadcrumb-separator">/</span>
                            <span>Attendance</span>
                        </nav>
                    </div>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary" onclick="exportReport()">
                        <span>üì•</span> Export Report
                    </button>
                </div>
            </header>

            <div class="content-area">
                <!-- Summary Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Overall Attendance</h3>
                            <div class="stat-value" id="overallAttendance">0%</div>
                        </div>
                        <div class="stat-icon primary">üìä</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Total Classes</h3>
                            <div class="stat-value" id="totalClasses">0</div>
                        </div>
                        <div class="stat-icon success">üìÖ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Students Below 75%</h3>
                            <div class="stat-value" id="lowAttendance">0</div>
                        </div>
                        <div class="stat-icon danger">‚ö†Ô∏è</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Perfect Attendance</h3>
                            <div class="stat-value" id="perfectAttendance">0</div>
                        </div>
                        <div class="stat-icon warning">üèÜ</div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card mb-6">
                    <div class="card-body">
                        <div class="flex gap-4" style="flex-wrap: wrap; align-items: flex-end;">
                            <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
                                <label for="courseFilter">Course</label>
                                <select class="form-control" id="courseFilter">
                                    <option value="">All Courses</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
                                <label for="monthFilter">Month</label>
                                <select class="form-control" id="monthFilter">
                                    <option value="">All Time</option>
                                    <option value="01">January</option>
                                    <option value="02">February</option>
                                    <option value="03">March</option>
                                    <option value="04">April</option>
                                    <option value="05">May</option>
                                    <option value="06">June</option>
                                    <option value="07">July</option>
                                    <option value="08">August</option>
                                    <option value="09">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
                                <label for="statusFilter">Status</label>
                                <select class="form-control" id="statusFilter">
                                    <option value="">All Students</option>
                                    <option value="low">Below 75%</option>
                                    <option value="good">75% - 90%</option>
                                    <option value="excellent">Above 90%</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                        </div>
                    </div>
                </div>

                <!-- Course-wise Attendance Chart -->
                <div class="card mb-6">
                    <div class="card-header">
                        <h3>üìà Course-wise Attendance Overview</h3>
                    </div>
                    <div class="card-body">
                        <div id="courseCharts">
                            <!-- Dynamic chart bars -->
                        </div>
                    </div>
                </div>

                <!-- Detailed Report Table -->
                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Detailed Attendance Report</h3>
                        <div class="table-actions">
                            <div class="search-input">
                                <span class="search-icon">üîç</span>
                                <input type="text" class="form-control" id="searchInput" placeholder="Search students...">
                            </div>
                        </div>
                    </div>
                    <div class="table-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>ID</th>
                                    <th>Course</th>
                                    <th>Present</th>
                                    <th>Absent</th>
                                    <th>Total Classes</th>
                                    <th>Percentage</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../../js/storage.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/attendance.js"></script>
    <script src="../../js/ui.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            UIManager.initDashboard();
            AuthManager.protectPage('admin');
            loadCourseFilter();
            loadReport();
            loadStats();
            loadCourseCharts();
            initEventListeners();
        });

        function loadCourseFilter() {
            const courses = StorageManager.get('courses') || [];
            const select = document.getElementById('courseFilter');
            
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = `${course.code} - ${course.name}`;
                select.appendChild(option);
            });
        }

        function loadStats() {
            const attendance = StorageManager.get('attendance') || [];
            const students = StorageManager.get('students') || [];
            
            // Calculate overall attendance
            const totalRecords = attendance.length;
            const presentRecords = attendance.filter(a => a.status === 'present').length;
            const overallPercent = totalRecords > 0 ? Math.round((presentRecords / totalRecords) * 100) : 0;
            
            document.getElementById('overallAttendance').textContent = overallPercent + '%';
            
            // Get unique dates (total classes)
            const uniqueDates = [...new Set(attendance.map(a => a.date))];
            document.getElementById('totalClasses').textContent = uniqueDates.length;
            
            // Calculate per-student attendance
            let lowCount = 0;
            let perfectCount = 0;
            
            students.forEach(student => {
                const studentAttendance = attendance.filter(a => a.studentId === student.id);
                const present = studentAttendance.filter(a => a.status === 'present').length;
                const total = studentAttendance.length;
                const percent = total > 0 ? (present / total) * 100 : 0;
                
                if (percent < 75 && total > 0) lowCount++;
                if (percent === 100 && total > 0) perfectCount++;
            });
            
            document.getElementById('lowAttendance').textContent = lowCount;
            document.getElementById('perfectAttendance').textContent = perfectCount;
        }

        function loadCourseCharts() {
            const courses = StorageManager.get('courses') || [];
            const attendance = StorageManager.get('attendance') || [];
            const container = document.getElementById('courseCharts');
            
            if (courses.length === 0) {
                container.innerHTML = '<p class="text-muted text-center p-4">No courses available</p>';
                return;
            }
            
            let html = '';
            
            courses.forEach(course => {
                const courseAttendance = attendance.filter(a => a.courseId === course.id);
                const present = courseAttendance.filter(a => a.status === 'present').length;
                const total = courseAttendance.length;
                const percent = total > 0 ? Math.round((present / total) * 100) : 0;
                
                const barColor = percent >= 90 ? 'success' : percent >= 75 ? 'warning' : 'danger';
                
                html += `
                    <div style="margin-bottom: 20px;">
                        <div class="flex justify-between mb-2">
                            <span style="font-weight: 500;">${UIManager.escapeHTML(course.code)} - ${UIManager.escapeHTML(course.name)}</span>
                            <span style="font-weight: 600; color: var(--${barColor === 'success' ? 'accent-success' : barColor === 'warning' ? 'accent-warning' : 'accent-danger'});">${percent}%</span>
                        </div>
                        <div class="progress-bar" style="height: 12px;">
                            <div class="progress-fill ${barColor}" style="width: ${percent}%;"></div>
                        </div>
                        <div class="text-sm text-muted mt-1">${present} present out of ${total} total records</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function loadReport() {
            const students = StorageManager.get('students') || [];
            const courses = StorageManager.get('courses') || [];
            const attendance = StorageManager.get('attendance') || [];
            const tbody = document.getElementById('reportTableBody');
            
            // Get filter values
            const courseFilter = document.getElementById('courseFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            let reportData = [];
            
            // Generate report for each student-course combination
            students.forEach(student => {
                const studentCourses = courseFilter 
                    ? courses.filter(c => c.id === courseFilter)
                    : courses;
                
                studentCourses.forEach(course => {
                    let courseAttendance = attendance.filter(
                        a => a.studentId === student.id && a.courseId === course.id
                    );
                    
                    // Apply month filter
                    if (monthFilter) {
                        courseAttendance = courseAttendance.filter(a => {
                            const date = new Date(a.date);
                            return String(date.getMonth() + 1).padStart(2, '0') === monthFilter;
                        });
                    }
                    
                    if (courseAttendance.length === 0) return;
                    
                    const present = courseAttendance.filter(a => a.status === 'present').length;
                    const absent = courseAttendance.filter(a => a.status === 'absent').length;
                    const total = courseAttendance.length;
                    const percent = Math.round((present / total) * 100);
                    
                    // Apply status filter
                    if (statusFilter === 'low' && percent >= 75) return;
                    if (statusFilter === 'good' && (percent < 75 || percent > 90)) return;
                    if (statusFilter === 'excellent' && percent <= 90) return;
                    
                    reportData.push({
                        student,
                        course,
                        present,
                        absent,
                        total,
                        percent
                    });
                });
            });
            
            if (reportData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center p-6">
                            <div class="empty-state">
                                <div class="icon">üìã</div>
                                <h3>No Records Found</h3>
                                <p>No attendance records match your filters.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = reportData.map(row => {
                const statusClass = row.percent >= 90 ? 'success' : row.percent >= 75 ? 'warning' : 'danger';
                const statusText = row.percent >= 90 ? 'Excellent' : row.percent >= 75 ? 'Good' : 'Low';
                
                return `
                    <tr>
                        <td>
                            <div class="flex items-center gap-3">
                                <div class="user-avatar" style="width:36px;height:36px;font-size:12px;">
                                    ${row.student.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                                </div>
                                <span>${UIManager.escapeHTML(row.student.name)}</span>
                            </div>
                        </td>
                        <td>${UIManager.escapeHTML(row.student.id)}</td>
                        <td>
                            <span class="badge badge-primary">${UIManager.escapeHTML(row.course.code)}</span>
                        </td>
                        <td style="color: var(--accent-success); font-weight: 600;">${row.present}</td>
                        <td style="color: var(--accent-danger); font-weight: 600;">${row.absent}</td>
                        <td>${row.total}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="progress-bar" style="width: 80px; height: 8px;">
                                    <div class="progress-fill ${statusClass}" style="width: ${row.percent}%;"></div>
                                </div>
                                <span style="font-weight: 600;">${row.percent}%</span>
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-${statusClass}">${statusText}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function applyFilters() {
            loadReport();
            UIManager.showToast('Filters applied!', 'success');
        }

        function exportReport() {
            // Simple CSV export
            const students = StorageManager.get('students') || [];
            const courses = StorageManager.get('courses') || [];
            const attendance = StorageManager.get('attendance') || [];
            
            let csv = 'Student Name,Student ID,Course,Present,Absent,Total,Percentage\n';
            
            students.forEach(student => {
                courses.forEach(course => {
                    const courseAttendance = attendance.filter(
                        a => a.studentId === student.id && a.courseId === course.id
                    );
                    
                    if (courseAttendance.length === 0) return;
                    
                    const present = courseAttendance.filter(a => a.status === 'present').length;
                    const absent = courseAttendance.filter(a => a.status === 'absent').length;
                    const total = courseAttendance.length;
                    const percent = Math.round((present / total) * 100);
                    
                    csv += `"${student.name}","${student.id}","${course.code}",${present},${absent},${total},${percent}%\n`;
                });
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'attendance_report.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            UIManager.showToast('Report exported successfully!', 'success');
        }

        function initEventListeners() {
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#reportTableBody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(query) ? '' : 'none';
                });
            });
        }
    </script>
</body>
</html>
